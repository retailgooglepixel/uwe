<script>
        // --- 1. FIREBASE CONFIG ---
        const firebaseConfig = {
          apiKey: "AIzaSyD9Ha0JayocUGshcgMtPpkaaWFQoX6R8_s",
          authDomain: "uwys-pixel-app.firebaseapp.com",
          projectId: "uwys-pixel-app",
          storageBucket: "uwys-pixel-app.firebasestorage.app",
          messagingSenderId: "600178641202",
          appId: "1:600178641202:web:c8474cb7a83ff1f517af2b",
          measurementId: "G-26JT9BRQ8K"
        };

        let db = null;
        try {
            if (typeof firebase !== 'undefined') {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                // Offline Persistence aktivieren, damit es auch ohne Netz flÃ¼ssig wirkt
                db.enablePersistence().catch(err => {
                    if (err.code == 'failed-precondition') {
                        console.log("Persistence failed: Multiple tabs open");
                    } else if (err.code == 'unimplemented') {
                        console.log("Persistence not supported");
                    }
                });
            }
        } catch (e) { console.error(e); }

        // --- 2. STATE & DATA ---
        let user = null;
        let state = {
            happiness: 50, xp: 0, level: 1, 
            joinedDate: new Date().getTime(),
            inventory: { toy: false, house: false },
            dailyTasksCompleted: { feed:false, walk:false, pet:false, train:false, play:false, clean:false },
            battleWonToday: false,
            lastPlayedDate: null
        };

        const battleDescriptions = {
            "Magic Eraser": "Pixel radiert Probleme weg!",
            "Best Take": "Pixel tauscht Gesichter aus!",
            "Night Sight": "Pixel macht die Nacht zum Tag!",
            "Super Res Zoom": "Pixel zoomt extrem nah ran!",
            "Gemini Live": "Pixel nutzt KI-Wissen!",
            "Audio Eraser": "Pixel filtert LÃ¤rm heraus!",
            "Circle to Search": "Pixel kreist den Gegner ein!",
            "Call Screen": "Pixel blockt den Angriff!",
            "Live Translate": "Pixel Ã¼bersetzt den Schaden!",
            "Real Tone": "Pixel zeigt wahre StÃ¤rke!",
            "Video Boost": "Pixel optimiert die Leistung!",
            "Astrophotography": "Pixel greift aus dem All an!"
        };
        const battleFeatures = Object.keys(battleDescriptions);
        const enemyExcuses = ["Phone X wird heiÃŸ...", "Phone X ruckelt...", "Phone X sucht Netz...", "Phone X Speicher voll...", "Phone X stÃ¼rzt ab...", "Phone X Akku leer..."];

        const questions = {
            feed: [ { q: "Wie lange hÃ¤lt der Akku im Extrem-Energiesparmodus?", options: ["Bis zu 48h", "Bis zu 72h", "Bis zu 100h"], a: 2 }, { q: "Schnelleres Laden?", options: ["MagSafe", "Pixelsnap Qi2", "SuperVOOC"], a: 1 } ],
            walk: [ { q: "Maximaler Zoom Pixel 10 Pro?", options: ["30x", "50x", "100x"], a: 2 }, { q: "Hilfe fÃ¼r Winkel?", options: ["Kamera-Coach", "Winkel-Meister", "Foto-Guide"], a: 0 } ],
            pet: [ { q: "Display Name?", options: ["OLED Pro", "Super Actua", "Retina XDR"], a: 1 }, { q: "Update Garantie?", options: ["3 J", "5 J", "7 J"], a: 2 } ],
            train: [ { q: "Video-Gen in Gemini?", options: ["Sora", "Veo 3", "CineMake"], a: 1 }, { q: "Live Unterhaltung?", options: ["Gemini Voice", "Gemini Live", "Talk"], a: 1 } ],
            play: [ { q: "Gruppenfoto Feature?", options: ["SelbstauslÃ¶ser", "Mich hinzufÃ¼gen", "Magic Eraser"], a: 1 }, { q: "Max Personen?", options: ["5", "10", "20"], a: 2 } ],
            clean: [ { q: "Sicherheitschip?", options: ["Knox", "Titan M2", "Secure Enclave"], a: 1 }, { q: "Anrufschutz?", options: ["Spam-Block", "Betrugserkennung", "Shield"], a: 1 } ]
        };

        // --- 3. STARTUP ---
        window.onload = function() { checkAuth(); };

        function checkAuth() {
            const localUser = localStorage.getItem('uweStateUserV21'); // Version hochgezÃ¤hlt
            if (localUser) {
                user = JSON.parse(localUser);
                document.getElementById('auth-overlay').style.display = 'none';
                loadState();
            }
        }

        // --- 4. INTELLIGENTER LOGIN (RESTORE FUNCTION) ---
        function handleLogin(e) {
            e.preventDefault();
            const fname = document.getElementById('fname').value.trim();
            const lname = document.getElementById('lname').value.trim();
            const storeid = document.getElementById('storeid').value.trim();

            if(!fname || !lname || !storeid) {
                alert("Bitte alle Felder ausfÃ¼llen!");
                return;
            }

            // Button deaktivieren um Doppelklick zu vermeiden
            const btn = document.querySelector('#auth-overlay .primary-btn');
            btn.innerText = "Lade Daten...";
            btn.disabled = true;

            const docId = `${storeid}_${lname}`;

            // Check Firebase first
            if (db) {
                db.collection('users').doc(docId).get().then((doc) => {
                    if (doc.exists) {
                        // FALL A: Nutzer existiert in Cloud -> WIEDERHERSTELLEN
                        const data = doc.data();
                        
                        // User lokal speichern
                        user = { fname: data.fname, lname: data.lname, storeid: data.storeid };
                        localStorage.setItem('uweStateUserV21', JSON.stringify(user));

                        // Spielstand aus Cloud holen und lokal Ã¼berschreiben
                        if (data.state) {
                            state = data.state;
                            // Sicherstellen, dass state valide ist
                            if (!state.inventory) state.inventory = { toy: false, house: false };
                            localStorage.setItem('uweStateV21', JSON.stringify(state));
                            showToast("Spielstand wiederhergestellt! ðŸŽ‰");
                        } else {
                            // Fallback falls User da ist, aber kein State
                            state.joinedDate = new Date().getTime();
                            saveState();
                        }

                    } else {
                        // FALL B: Neuer Nutzer -> NEU ERSTELLEN
                        user = { fname, lname, storeid };
                        localStorage.setItem('uweStateUserV21', JSON.stringify(user));
                        
                        state.joinedDate = new Date().getTime();
                        saveState();
                        
                        // In Cloud anlegen
                        db.collection('users').doc(docId).set({...user, joined: state.joinedDate});
                        showToast("Willkommen neu bei UWE!");
                    }
                    
                    finishLogin();

                }).catch((error) => {
                    console.error("Login Error:", error);
                    // FALL C: Kein Internet oder Fehler -> Offline weiter machen (Risiko: Ãœberschreiben spÃ¤ter)
                    alert("Keine Verbindung zum Server. Offline-Modus gestartet.");
                    
                    user = { fname, lname, storeid };
                    localStorage.setItem('uweStateUserV21', JSON.stringify(user));
                    state.joinedDate = new Date().getTime();
                    saveState();
                    finishLogin();
                });
            } else {
                // Fallback ohne DB Config
                user = { fname, lname, storeid };
                localStorage.setItem('uweStateUserV21', JSON.stringify(user));
                state.joinedDate = new Date().getTime();
                saveState();
                finishLogin();
            }
        }

        function finishLogin() {
            document.getElementById('auth-overlay').style.display = 'none';
            updateVisuals();
            initNewsListener();
        }

        // --- 5. STATE MANAGEMENT ---
        function loadState() {
            const saved = localStorage.getItem('uweStateV21');
            if (saved) state = JSON.parse(saved);
            
            // Daily Reset Logic
            const today = new Date().toISOString().slice(0,10);
            if (state.lastPlayedDate !== today) {
                state.dailyTasksCompleted = { feed:false, walk:false, pet:false, train:false, play:false, clean:false };
                state.battleWonToday = false;
                state.lastPlayedDate = today;
                saveState();
            }
            updateVisuals();
            
            // Sync im Hintergrund (Lokal -> Cloud) beim Start
            if(db && user) {
                db.collection('users').doc(`${user.storeid}_${user.lname}`).update({
                    state: state,
                    lastActive: new Date().toISOString()
                }).catch(e => console.log("Sync background silent fail"));
            }
        }

        function saveState() {
            localStorage.setItem('uweStateV21', JSON.stringify(state));
            if(db && user) {
                // Wir speichern den kompletten 'state' in ein Feld in Firebase
                db.collection('users').doc(`${user.storeid}_${user.lname}`).update({state: state}).catch(e=>{});
            }
        }

        // --- 6. NEWS & FEEDBACK ---
        function initNewsListener() {
            if(db) {
                db.collection('news').doc('live').onSnapshot((doc) => {
                    if (doc.exists) {
                        const data = doc.data();
                        if (data.active) showNews(data.title, data.text);
                        else closeNews();
                    }
                });
            }
        }
        function showNews(title, text) {
            document.getElementById('news-title').innerText = title;
            document.getElementById('news-text').innerText = text;
            document.getElementById('news-overlay').style.display = 'flex';
        }
        function closeNews() { document.getElementById('news-overlay').style.display = 'none'; }

        function openFeedback() { document.getElementById('feedback-overlay').style.display = 'flex'; }
        function closeFeedback() { document.getElementById('feedback-overlay').style.display = 'none'; }
        function submitFeedback(r) { showToast("Danke!"); setTimeout(closeFeedback, 1000); if(db) db.collection('users').doc(`${user.storeid}_${user.lname}`).update({feedback:r}); }

        // --- 7. INTERACTIONS ---
        function interactToy() {
            const toy = document.getElementById('toy');
            toy.classList.add('toy-cuddle');
            const c = document.getElementById('pet-container');
            for(let i=0; i<5; i++) {
                const h = document.createElement('div'); h.className='heart-anim'; h.innerText='â¤ï¸';
                h.style.left = (40 + Math.random()*20) + '%'; h.style.top = '50%'; h.style.animationDelay = (i*0.3)+'s';
                c.appendChild(h); setTimeout(()=>h.remove(), 2000);
            }
            document.getElementById('pixel-pet').classList.add('happy'); 
            setTimeout(() => { toy.classList.remove('toy-cuddle'); document.getElementById('pixel-pet').classList.remove('happy'); }, 2500);
        }

        function interactHouse() {
            const pet = document.getElementById('pixel-pet');
            pet.classList.add('enter-house');
            setTimeout(() => { pet.classList.remove('enter-house'); }, 3000);
        }

        function calculateDays() { return Math.floor((new Date().getTime() - state.joinedDate) / (86400000)) + 1; }

        function updateVisuals() {
            const days = calculateDays();
            document.getElementById('days-val').innerText = days;
            
            let mood = "ðŸ˜";
            if(state.happiness >= 80) mood = "ðŸ¤©"; else if(state.happiness >= 50) mood = "ðŸ˜Š"; else if(state.happiness <= 20) mood = "ðŸ˜­";
            document.getElementById('mood-val').innerText = mood;

            let scale = 0.6;
            // Hide items
            document.getElementById('main-age-baby').style.display = 'none';
            document.getElementById('main-age-teen').style.display = 'none';
            document.getElementById('main-age-adult').style.display = 'none';

            let ageGroup = 'baby';
            if (days <= 3) { scale = 0.6; ageGroup = 'baby'; document.getElementById('main-age-baby').style.display = 'block'; }
            else if (days <= 14) { scale = 0.85; ageGroup = 'teen'; document.getElementById('main-age-teen').style.display = 'block'; }
            else { scale = 1.0; ageGroup = 'adult'; document.getElementById('main-age-adult').style.display = 'block'; }
            
            document.documentElement.style.setProperty('--current-scale', scale);
            document.documentElement.setAttribute('data-age-group', ageGroup);

            document.getElementById('level-val').innerText = state.level;
            document.getElementById('tele-lens').style.display = state.level > 1 ? 'block' : 'none';

            if(state.inventory.toy) document.getElementById('toy').classList.add('visible');
            if(state.inventory.house) document.getElementById('house').classList.add('visible');

            const pet = document.getElementById('pixel-pet');
            if (!pet.classList.contains('spinning')) {
                let bodyColor = "#6996D3"; 
                if (state.happiness >= 60) { bodyColor = "#c3ecd2"; }
                else if (state.happiness <= 30) { bodyColor = "#9aa0a6"; }
                document.documentElement.style.setProperty('--pixel-body', bodyColor);
            }
        }

        function petInteraction() {
            const pet = document.getElementById('pixel-pet');
            if (pet.classList.contains('spinning')) return;
            pet.classList.add('spinning');
            
            const c = document.getElementById('pet-container');
            for(let i=0; i<3; i++) {
                const h = document.createElement('div'); h.className='heart-anim'; h.innerText='â¤ï¸';
                h.style.left = (45 + Math.random()*10) + '%'; h.style.top = '40%'; h.style.animationDelay = (i*0.2)+'s';
                c.appendChild(h); setTimeout(()=>h.remove(), 1500);
            }

            if (state.happiness < 100) state.happiness += 5;
            saveState();
            setTimeout(() => { pet.classList.remove('spinning'); updateVisuals(); }, 1000);
        }

        // --- 8. GAMEPLAY ---
        function startDailyTask(cat) {
            const q = questions[cat][Math.floor(Math.random()*questions[cat].length)];
            document.getElementById('modal-overlay').style.display = 'flex';
            document.getElementById('category-title').innerText = cat.toUpperCase();
            document.getElementById('question-text').innerText = q.q;
            const c = document.getElementById('options-container'); c.innerHTML = '';
            document.getElementById('feedback-msg').innerText = '';
            q.options.forEach((o, i) => {
                const b = document.createElement('button'); b.className='option-btn'; b.innerText=o;
                b.onclick = () => checkAnswer(i, q.a, b, cat); c.appendChild(b);
            });
        }
        function checkAnswer(i, a, b, cat) {
            const all = document.querySelectorAll('.option-btn'); all.forEach(x=>x.disabled=true);
            const fb = document.getElementById('feedback-msg');
            if(i===a) {
                b.classList.add('correct'); fb.innerText="Richtig!"; fb.style.color="green";
                state.dailyTasksCompleted[cat]=true; checkLevelUp();
            } else {
                b.classList.add('wrong'); fb.innerText="Falsch."; fb.style.color="red"; state.happiness = Math.max(0, state.happiness-10);
            }
            saveState(); setTimeout(()=>{document.getElementById('modal-overlay').style.display='none'; updateVisuals();},1000);
        }

        function checkLevelUp() {
            state.happiness = Math.min(100, state.happiness+20);
            const allTasks = Object.values(state.dailyTasksCompleted).every(v=>v);
            
            if (allTasks) {
                if(!state.inventory.toy) { state.inventory.toy=true; showToast("Spielzeug freigeschaltet!"); }
                
                // Level Up nur wenn Aufgaben UND Battle gewonnen
                if (state.battleWonToday) {
                    state.level++;
                    state.battleWonToday = false; 
                    showToast("ðŸŽ‰ LEVEL UP!");
                    if(state.level >= 3 && !state.inventory.house) { state.inventory.house=true; showToast("HÃ¼tte freigeschaltet!"); }
                }
            }
            saveState();
        }

        function showToast(m) { const t=document.getElementById('toast'); t.innerText=m; t.style.opacity=1; setTimeout(()=>t.style.opacity=0,3000); }

        // --- 9. BATTLE ---
        let battleState = { heroHP: 100, enemyHP: 100, active: false };

        function initBattle() {
            battleState = { heroHP: 100, enemyHP: 100, active: true };
            updateBattleUI();
            generateAttackButtons();
            
            // Sync Age Items
            const ageGroup = document.documentElement.getAttribute('data-age-group') || 'baby';
            document.getElementById('battle-age-baby').style.display = (ageGroup === 'baby') ? 'block' : 'none';
            document.getElementById('battle-age-teen').style.display = (ageGroup === 'teen') ? 'block' : 'none';
            document.getElementById('battle-age-adult').style.display = (ageGroup === 'adult') ? 'block' : 'none';

            document.getElementById('controls').style.display = 'none'; 
            document.getElementById('battle-overlay').style.display = 'flex';
            document.getElementById('battle-log').innerText = "Ein wildes Phone X erscheint!\n";
        }

        function logText(text) {
            const el = document.getElementById('battle-log');
            el.innerText += text + "\n";
            document.getElementById('battle-log-container').scrollTop = document.getElementById('battle-log-container').scrollHeight;
        }

        function generateAttackButtons() {
            const c = document.getElementById('battle-actions'); c.innerHTML = '';
            battleFeatures.sort(()=>0.5-Math.random()).slice(0,4).forEach(name => {
                const b = document.createElement('button'); b.className='attack-btn'; b.innerText=name;
                b.onclick = () => performTurn(name); c.appendChild(b);
            });
        }

        function updateBattleUI() {
            document.getElementById('hero-hp').style.width = battleState.heroHP + '%';
            document.getElementById('enemy-hp').style.width = battleState.enemyHP + '%';
            
            const heroMouth = document.getElementById('hero-mouth');
            const enemyMouth = document.getElementById('enemy-mouth');
            
            if(battleState.enemyHP < battleState.heroHP) {
                heroMouth.style.height = "10px"; heroMouth.style.borderRadius = "0 0 50% 50%"; heroMouth.style.borderBottom = "3px solid black"; heroMouth.style.borderTop = "none";
            } else {
                heroMouth.style.height = "0"; heroMouth.style.borderRadius = "0"; heroMouth.style.borderBottom = "3px solid black";
            }
            if(battleState.enemyHP < 40) {
                enemyMouth.style.height = "10px"; enemyMouth.style.borderRadius = "50% 50% 0 0"; enemyMouth.style.borderTop = "3px solid black"; enemyMouth.style.borderBottom = "none";
            } else {
                enemyMouth.style.height = "0"; enemyMouth.style.borderBottom = "3px solid black";
            }
        }

        function performTurn(feat) {
            if(!battleState.active) return;
            logText(`Pixel nutzt ${feat}!\n${battleDescriptions[feat]}`);
            
            const heroDiv = document.getElementById('hero-fighter');
            heroDiv.classList.add('throw-anim');
            throwProjectile(heroDiv, document.getElementById('enemy-fighter'), 'ðŸš€');

            setTimeout(() => {
                heroDiv.classList.remove('throw-anim');
                const dmg = 20 + Math.floor(Math.random()*15);
                battleState.enemyHP = Math.max(0, battleState.enemyHP - dmg);
                updateBattleUI();
                if(battleState.enemyHP <= 0) endBattle(true);
                else { disableBtns(true); setTimeout(enemyTurn, 1500); }
            }, 500);
        }

        function enemyTurn() {
            if(!battleState.active) return;
            const excuse = enemyExcuses[Math.floor(Math.random()*enemyExcuses.length)];
            logText(`${excuse}`);
            
            const enemyDiv = document.getElementById('enemy-fighter');
            enemyDiv.classList.add('throw-anim');
            throwProjectile(enemyDiv, document.getElementById('hero-fighter'), 'ðŸª¨');

            setTimeout(() => {
                enemyDiv.classList.remove('throw-anim');
                const dmg = 5 + Math.floor(Math.random()*10);
                battleState.heroHP = Math.max(0, battleState.heroHP - dmg);
                updateBattleUI();
                if(battleState.heroHP <= 0) endBattle(false);
                else { disableBtns(false); generateAttackButtons(); }
            }, 500);
        }

        function throwProjectile(from, to, icon) {
            const p = document.createElement('div'); p.className = 'projectile'; p.innerText = icon; p.style.display = 'block'; document.body.appendChild(p);
            const start = from.getBoundingClientRect(); const end = to.getBoundingClientRect();
            p.style.left = start.left+30+'px'; p.style.top = start.top+30+'px';
            p.animate([{ transform: 'translate(0,0) scale(1)' }, { transform: `translate(${end.left-start.left}px, ${end.top-start.top}px) scale(1.5)` }], { duration: 400, easing: 'ease-in' }).onfinish = () => {
                p.remove(); createExplosion(end.left+20, end.top+40); to.classList.add('anim-hit'); setTimeout(()=>to.classList.remove('anim-hit'), 400);
            };
        }
        function createExplosion(x, y) {
            const ex = document.createElement('div'); ex.className = 'explosion'; ex.innerText = 'ðŸ’¥'; ex.style.left = x+'px'; ex.style.top = y+'px'; document.body.appendChild(ex); setTimeout(() => ex.remove(), 500);
        }
        function disableBtns(d) { document.querySelectorAll('.attack-btn').forEach(b=>b.disabled=d); }

        function endBattle(won) {
            battleState.active = false;
            if(won) {
                logText("SIEG! Phone X hat keinen Akku mehr.");
                confetti();
                state.happiness = 100;
                state.battleWonToday = true;
                checkLevelUp();
            } else {
                logText("Niederlage...");
            }
            setTimeout(() => {
                document.getElementById('battle-overlay').style.display = 'none';
                document.getElementById('controls').style.display = 'grid'; 
                updateVisuals();
            }, 2500);
        }
    </script>
</body>
</html>
